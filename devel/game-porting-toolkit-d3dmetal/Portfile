# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                game-porting-toolkit-d3dmetal
version             1.0
categories          devel
maintainers         {@gcenx}
platforms           {darwin any >= 23}
license             Restrictive Nomirror

supported_archs     x86_64

description         Apple Game Porting Toolkit - D3DMetal
long_description    {*}${description}

master_sites        https://download.developer.apple.com/Developer_Tools/Game_porting_toolkit_beta/Game_porting_toolkit_beta.dmg

distname            Game_porting_toolkit_beta
use_dmg             yes

checksums           rmd160  ea68d96d36353d5ac90d59dcf6f762acdeab6e10 \
                    sha256  1c28a0285f39d1326657f45cb33464fb78d704dc43f2ad9be103258ecae3bdaf \
                    size    53388563

use_configure       no

pre-fetch {
    if {![file isfile ${distpath}/${distfiles}]} {
        ui_error "This port cannot download the needed files automatically."
        ui_error "Please log in to your Apple Developer account at:"
        ui_error ""
        ui_error "https://developer.apple.com/download/"
        ui_error ""
        ui_error "Then paste this URL into your browser:"
        ui_error ""
        ui_error "${master_sites}"
        ui_error ""
        ui_error "Place the downloaded file in this directory:"
        ui_error ""
        ui_error "${distpath}"
        ui_error ""
        ui_error "Then retry installing this port."
        return -code error "distfiles missing"
    }
}

build {}

destroot {
    set d3dmetal_dir ${prefix}/libexec/game-porting-toolkit/lib
    set d3dmetal_framework D3DMetal.framework/Versions/A
    xinstall -d ${destroot}${d3dmetal_dir}

    system "ditto ${worksrcpath}/lib ${destroot}${d3dmetal_dir}"

    file copy ${worksrcpath}/gameportingtoolkit ${destroot}${prefix}/bin/gameportingtoolkit
    reinplace -q "s|`brew --prefix game-porting-toolkit`|${prefix}/libexec/game-porting-toolkit|g"     ${destroot}${prefix}/bin/gameportingtoolkit
    file copy ${worksrcpath}/gameportingtoolkit-no-esync ${destroot}${prefix}/bin/gameportingtoolkit-no-esync
    reinplace -q "s|`brew --prefix game-porting-toolkit`|${prefix}/libexec/game-porting-toolkit|g"     ${destroot}${prefix}/bin/gameportingtoolkit-no-esync
    file copy ${worksrcpath}/gameportingtoolkit-no-hud ${destroot}${prefix}/bin/gameportingtoolkit-no-hud
    reinplace -q "s|`brew --prefix game-porting-toolkit`|${prefix}/libexec/game-porting-toolkit|g"     ${destroot}${prefix}/bin/gameportingtoolkit-no-hud

    # Not sure why these have an arm64 slice when libd3dshared.dylib is x86_64 only
    system -W ${destroot}${d3dmetal_dir}/external/${d3dmetal_framework} "lipo -thin ${configure.build_arch} D3DMetal -o D3DMetal 2> /dev/null"
    system -W ${destroot}${d3dmetal_dir}/external/${d3dmetal_framework}/Resources "lipo -thin ${configure.build_arch} libdxccontainer.dylib -o libdxccontainer.dylib 2> /dev/null"
    system -W ${destroot}${d3dmetal_dir}/external/${d3dmetal_framework}/Resources "lipo -thin ${configure.build_arch} libdxcompiler.dylib -o libdxcompiler.dylib 2> /dev/null"
    system -W ${destroot}${d3dmetal_dir}/external/${d3dmetal_framework}/Resources "lipo -thin ${configure.build_arch} libdxilconv.dylib -o libdxilconv.dylib 2> /dev/null"
    system -W ${destroot}${d3dmetal_dir}/external/${d3dmetal_framework}/Resources "lipo -thin ${configure.build_arch} libmetalirconverter.dylib -o libmetalirconverter.dylib 2> /dev/null"

    # Remove useless symlink
    delete ${destroot}${d3dmetal_dir}/external/D3DMetal.framework/Headers
}

set docdir ${prefix}/share/doc/game-porting-toolkit/D3DMetal

post-destroot {
    xinstall -d ${destroot}${docdir}
    xinstall -m 0644 -W ${worksrcpath} \
        Acknowledgements.rtf \
        License.rtf \
        "Read Me.rtf" \
        ${destroot}${docdir}
}

notes "
    Please review the D3DMetal documentation found at ${docdir}
"

livecheck.type              none
