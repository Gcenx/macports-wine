# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           muniversal 1.1

name                cctools-973

# Xcode 12
github.setup        tpoechtrager cctools-port f28fb5e

# Version must use the following scheme <version>-<commit-date>
set commitdate      20230317
version             973.0.1-${commitdate}
revision            0

categories          devel
platforms           darwin
maintainers         {@gcenx}
license             {APSL-2 GPL-2+}
installs_libs       no

description         Compiler Tools for Mac OS X and Darwin
long_description    A set of essential tools to support development \
                    on Mac OS X and Darwin. Conceptually similar \
                    similar to binutils on other platforms.

set cctools_ver     973
set ld64_ver        609

dist_subdir         cctools
worksrcdir          ${worksrcpath}/cctools

homepage \
    https://opensource.apple.com/source/${name}/

checksums \
    rmd160  4affff07c17e8d55d42de8321bd508aa7dc25c8c \
    sha256  11f6699326dba678c5b62d4c2d2ed026cdc64e16f1c30f2636ab3e0cead3a9b7 \
    size    2936074

patch.pre_args      -p2

patchfiles \
    0001-fixup-for-macports.diff \
    0002-restore-no_new_main.diff \
    0003-ld64-remove-i386-architecture-is-deprecated.diff \
    0004-fix-builds-with-old-sdks.diff

# Open pull-requests that have yet to be merged
patchfiles-append \
    pr-116.diff \
    pr-118.diff \
    pr-121.diff \
    pr-126.diff \
    pr-135.diff

post-patch {
    reinplace "s|LD64_VERSION_NUM|609|g"    ${worksrcpath}/ld64/src/3rd/helper.c
}

configure.args \
    --disable-lto-support \
    --disable-tapi-support \
    --disable-xar-support

if {${subport} eq "${name}"} {
    set sub_prefix          ${prefix}/libexec/cctools-${cctools_ver}
    configure.pre_args      --prefix=${sub_prefix}
}

subport ld64-609 {
    version                 609-${commitdate}

    description             ld64 is the new mach-o linker
    long_description        ld64 combines several object files and libraries, \
                            resolves references, and produces an ouput file.

    if {${os.major} < 17} {
        # For a new enough install_name_tool
        depends_build       port:cctools
    }

    depends_lib             port:libtapi
    configure.args-delete   --disable-tapi-support
    build.cmd               make -C ld64

    post-destroot {
        xinstall -d ${destroot}${prefix}/libexec/ld64
        copy ${destroot}${prefix}/bin/ld                ${destroot}${prefix}/libexec/ld64/ld-${ld64_ver}
        file rename ${destroot}${prefix}/bin/dyldinfo   ${destroot}${prefix}/bin/dyldinfo-${ld64_ver}
        file rename ${destroot}${prefix}/bin/ld         ${destroot}${prefix}/bin/ld-${ld64_ver}
        file rename ${destroot}${prefix}/bin/machocheck ${destroot}${prefix}/bin/machocheck-${ld64_ver}
        file rename ${destroot}${prefix}/bin/ObjectDump ${destroot}${prefix}/bin/ObjectDump-${ld64_ver}
        file rename ${destroot}${prefix}/bin/unwinddump ${destroot}${prefix}/bin/unwinddump-${ld64_ver}
        delete ${destroot}${prefix}/share
    }
}

if {${os.major} < 17} {
    depends_build-append    port:clang-11-bootstrap
    configure.cc            ${prefix}/libexec/clang-11-bootstrap/bin/clang
    configure.cxx           ${configure.cc}++
    configure.compiler.add_deps no
}
