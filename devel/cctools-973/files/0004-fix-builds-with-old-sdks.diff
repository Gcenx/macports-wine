From b509a4eb1a517d37ed68031cb50752d6214cf8b1 Mon Sep 17 00:00:00 2001
From: Gcenx <38226388+Gcenx@users.noreply.github.com>
Date: Sun, 6 Mar 2022 21:29:09 -0500
Subject: [PATCH] Fix builds with older SDKs

---
 cctools/include/stuff/diagnostics.h    | 9 +--------
 cctools/ld64/src/ld/libcodedirectory.c | 4 ++--
 2 files changed, 3 insertions(+), 10 deletions(-)

diff --git a/cctools/include/stuff/diagnostics.h b/cctools/include/stuff/diagnostics.h
index 4981595..c8a07b9 100644
--- a/cctools/include/stuff/diagnostics.h
+++ b/cctools/include/stuff/diagnostics.h
@@ -60,13 +60,6 @@ void diagnostics_log_msg(enum diagnostic_level level, const char* message);
  */
 void diagnostics_write(void);
 
-#if defined(__APPLE__ ) && defined(__has_builtin)
-#  if __has_builtin(__builtin_available)
-#    define HAVE_OPENMEMSTREAM_RUNTIME __builtin_available(macOS 10.13, *)
-#  endif
-#endif
-#ifndef HAVE_OPENMEMSTREAM_RUNTIME
-#  define HAVE_OPENMEMSTREAM_RUNTIME 1
-#endif
+#define HAVE_OPENMEMSTREAM_RUNTIME 0
 
 #endif /* diagnostics_h */
diff --git a/cctools/ld64/src/ld/libcodedirectory.c b/cctools/ld64/src/ld/libcodedirectory.c
index 4e17cd1..902314a 100644
--- a/cctools/ld64/src/ld/libcodedirectory.c
+++ b/cctools/ld64/src/ld/libcodedirectory.c
@@ -19,7 +19,7 @@
 #include <sys/mman.h>
 #include <sys/queue.h>
 
-#if defined(HAVE_DISPATCH_DISPATCH_H) && HAVE_DISPATCH_DISPATCH_H // ld64-port
+#if defined(DISPATCH_APPLY_AUTO) // ld64-port
 #define LIBCD_PARALLEL 1
 #endif
 
@@ -68,7 +68,7 @@
 #endif
 
 #define bl htonl
-#ifndef __APPLE__ // ld64-port
+#if !defined(htonll) && !defined(ntohll) // ld64-port
 #if __BYTE_ORDER == __LITTLE_ENDIAN
 #define htonll __builtin_bswap64
 #else
-- 
2.32.0 (Apple Git-132)
