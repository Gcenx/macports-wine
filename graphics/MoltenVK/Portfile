# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
categories                  graphics
maintainers                 openmaintainer
license                     Apache-2

supported_archs             x86_64
platforms                   darwin
description                 an implementation of Vulkan for Metal
name                        MoltenVK
conflicts                   VulkanSDK
set my_name                 MoltenVK

long_description            ${name} is an implementation of the high-performance, \
                            industry-standard Vulkan graphics and compute API, that \
                            runs on Apple's Metal graphics framework.

# MoltenVK version from https://github.com/KhronosGroup/MoltenVK/releases
version                     1.0.44

# This needs to match the LunarG SDK version
set VulkanSDK_version       1.2.148.0

distname                    vulkansdk-macos-${VulkanSDK_version}
use_dmg                     yes

master_sites                https://sdk.lunarg.com/sdk/download/${VulkanSDK_version}/mac/

checksums                   rmd160  3967cbed755e9f9ea2391b3b6fa8dc8058b41519 \
                            sha256  54042a138f6497a3cf173a56449cb7310e9a9d4934c4ec3f65c7b0b3e43cb848 \
                            size    223296311

use_configure       no
build {}

subport VulkanSDK {
    name                        VulkanSDK
    conflicts                   MoltenVK
    set my_name                 VulkanSDK
    dist_subdir                 MoltenVK
    version                     ${VulkanSDK_version}
}

destroot {
    if {${subport} eq {VulkanSDK}} {
        set output_dir ${worksrcpath}/macOS
        file delete -force ${destroot}${prefix}/bin
        file copy ${output_dir}/bin ${destroot}${prefix}
        file copy ${output_dir}/Frameworks/vulkan.framework ${destroot}${frameworks_dir}
        file delete -force ${destroot}${prefix}/lib
        file copy ${output_dir}/lib ${destroot}${prefix}
        file delete -force ${destroot}${prefix}/include
        file copy ${output_dir}/include ${destroot}${prefix}
        file delete -force ${destroot}${prefix}/share
        file copy ${output_dir}/share ${destroot}${prefix}
        reinplace "s|../../..|${prefix}|g" ${destroot}${prefix}/share/vulkan/icd.d/MoltenVK_icd.json \
                                           ${destroot}${prefix}/share/vulkan/explicit_layer.d/VkLayer_api_dump.json \
                                           ${destroot}${prefix}/share/vulkan/explicit_layer.d/VkLayer_khronos_validation.json
    } else {
        set output_dir ${worksrcpath}/MoltenVK/macOS
        copy ${output_dir}/dynamic/libMoltenVK.dylib ${destroot}${prefix}/lib
        copy ${output_dir}/framework/MoltenVK.framework ${destroot}${frameworks_dir}
    }
}

platform darwin {
    if {${os.major} < 15} {
        archive_sites
        distfiles
        depends_build
        pre-fetch {
            ui_error "${subport} @${version} requires macOS El Capitan or later"
            return -code error "incompatible OS X version"
        }
    }
}
