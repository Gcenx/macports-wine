# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   github 1.0

github.setup                The-Wineskin-Project MoltenVK 1.2.0 v
github.tarball_from         releases

platforms                   {darwin >= 15}
categories                  graphics
maintainers                 {@gcenx}
platforms                   macosx
license                     Apache-2

supported_archs             arm64 x86_64

description                 an implementation of Vulkan for Metal

long_description            ${name} is an implementation of the high-performance, \
                            industry-standard Vulkan graphics and compute API, that \
                            runs on Apple's Metal graphics framework.

dist_subdir                 MoltenVK
use_xz                      yes

distname                    macos-${version}
checksums                   rmd160  415e49766421b4955b6ad60de4f28645d7b31cbb \
                            sha256  7b2160ba9d24ca7e8b277a8edb19e43710946934fd137714fe8695b3114d93f1 \
                            size    9735388

subport ${name}-CX {
     revision               1
     replaced_by            MoltenVK
}

use_configure               no
build                       {}

destroot {
    set output_dir ${workpath}/Package/Release/MoltenVK
    file copy ${output_dir}/dylib/macOS/libMoltenVK.dylib ${destroot}${prefix}/lib

    # Xcode11 and later are required to use "xcframework"
    # Headers currently break build due to Xcode 12 ProcessXCFramework bug:
    # https://developer.apple.com/forums/thread/651043?answerId=628400022#628400022
    if {${os.major} >= 18} {
        file copy ${output_dir}/MoltenVK.xcframework ${destroot}${frameworks_dir}
    }

    if {[variant_exists universal] && ![variant_isset universal] || ![variant_exists universal] || ${os.major} < 20} {
        system -W ${destroot}${prefix}/lib "lipo -thin ${configure.build_arch} libMoltenVK.dylib -o libMoltenVK.dylib 2> /dev/null"
    }
}
